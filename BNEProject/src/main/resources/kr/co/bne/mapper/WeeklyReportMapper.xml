<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.bne.mapper.WeeklyReport">
	<!-- 새로 작성 시 지난 주 까지의 매출액 -->
	<select id="selectThisMonthlySales" parameterType="String" resultType="Integer">
		<![CDATA[
		SELECT  SUM(RESULT) AS RECENT_SALES_SUM
		FROM    (SELECT CASE WHEN TO_CHAR(NEXT_DAY(LPD.LAST_PLAN_DATE, 2), 'YYYYMM') = TO_CHAR(LPD.LAST_PLAN_DATE, 'YYYYMM')
		            		     THEN DR.SALES ELSE 0
		              			  END AS RESULT
		         	  FROM   DAILY_REPORT DR,(SELECT	TRUNC(MAX(PD.START_TIME),'DD') AS LAST_PLAN_DATE
		                   						              FROM		WEEKLY_REPORT WR, WEEKLY_PLAN WP, PLAN_DETAIL PD
		                                 					WHERE		WR.EMPLOYEE_ID = #{value} AND
		                                         							WR.WEEKLY_REPORT_ID = WP.WEEKLY_REPORT_ID AND
		                                         							WP.WEEKLY_PLAN_ID = PD.WEEKLY_PLAN_ID) LPD 
		         	WHERE  DR.REG_DATE < LPD.LAST_PLAN_DATE + 1 AND 
		            		    TO_CHAR(DR.REG_DATE, 'YYYYMM') = TO_CHAR(LPD.LAST_PLAN_DATE, 'YYYYMM'))
		]]>
	</select>
	
	<!-- 새로 작성시 이번주에 필요한 매출 목표 -->
	<select id="selectSalesGoal" parameterType="String" resultType="Integer">
		<![CDATA[
		SELECT    CASE WHEN TO_CHAR(NEXT_DAY(LPD.LAST_PLAN_DATE, 2), 'YYYYMM') = TO_CHAR(LPD.LAST_PLAN_DATE, 'YYYYMM')
			          THEN MG.SALES_GOAL ELSE 0
			          END AS MONTHLY_SALES_GOAL
		FROM      MONTHLY_GOAL MG, (SELECT	TRUNC(MAX(PD.START_TIME),'DD') AS LAST_PLAN_DATE
							                            FROM   WEEKLY_REPORT WR, WEEKLY_PLAN WP, PLAN_DETAIL PD
							                            WHERE WR.EMPLOYEE_ID = #{value} AND
							                                   		WR.WEEKLY_REPORT_ID = WP.WEEKLY_REPORT_ID AND
							                                   		WP.WEEKLY_PLAN_ID = PD.WEEKLY_PLAN_ID) LPD
		WHERE     EMPLOYEE_ID = #{value} AND
				        YEAR = TO_NUMBER(TO_CHAR(LPD.LAST_PLAN_DATE, 'YYYY')) AND
				        MONTH = TO_NUMBER(TO_CHAR(LPD.LAST_PLAN_DATE, 'MM'))
		]]>
	</select>
	
	<!-- 새로 작성시 필요한 날짜 리스트 -->
	<select id="selectDayList" parameterType="String" resultType="Integer">
		SELECT   DISTINCT TRUNC(PD.START_TIME, 'DD') AS REPORT_PLAN_DAYS
		FROM     WEEKLY_REPORT WR, WEEKLY_PLAN WP, PLAN_DETAIL PD
		WHERE    WR.WEEKLY_REPORT_ID = WP.WEEKLY_REPORT_ID AND
				       WP.WEEKLY_PLAN_ID = PD.WEEKLY_PLAN_ID AND
				       WR.EMPLOYEE_ID = #{value}
		ORDER BY 1
	</select>
</mapper>