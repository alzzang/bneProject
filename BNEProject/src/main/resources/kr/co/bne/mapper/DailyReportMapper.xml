<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.bne.mapper.DailyReport">


	<resultMap type="DailyReportListElement" id="DailyReportListElement">
	<result column="employee_id" property="employee_id"/>
	<result column="employee_name" property="employee_name"/>
	<result column="title" property="title"/>
	<result column="reg_date" property="reg_date"/>
	<result column="approval_flag" property="approval_flag"/>
	<result column="idx" property="idx"/>
</resultMap>



<resultMap type="DailyReportTeamListElement" id="DailyReportTeamListElement">
	<result column="employee_id" property="employee_id"/>
	<result column="employee_name" property="employee_name"/>
	<result column="department_id" property="department_id"/>
	<result column="unApproval" property="unApproval"/>
</resultMap>





<!-- 전체 리스트 페이징 -->
<select id="selectDailyReportList" parameterType="hashmap" resultMap="DailyReportListElement"> 

	select idx, employee_id, employee_name, title, reg_date, approval_flag
	from (select ROW_NUMBER() OVER (order by reg_date desc) idx, d.employee_id, e.employee_name, d.title, to_char(reg_date, 'yyyy-mm-dd') reg_date, approval_flag
	      from daily_report d , employee e
	      where d.employee_id = e.employee_id
	      and d.department_id = (select department_id from employee where employee_id = #{user_id})
	      <if test="employee_id != null">
	      	and d.employee_id = #{employee_id}
	      </if>
	      <if test="reg_date != null">
	      	and to_char(d.reg_date, 'yyyy-mm-dd') = #{reg_date}
	      </if>
	      <if test="approval_flag != null">
	      	and d.approval_flag = #{approval_flag}
	      </if>
	      ) a  		
	where idx between 1 + #{perContentNum}*(#{startIdx}-1) and #{startIdx}*#{perContentNum}
	order by idx asc 

</select>



<!-- 전체 리스트 페이지 갯수 -->
<select id="getPagingNum_DailyReportList" parameterType="hashmap" resultType="int"> 

	select ceil(count(*)/#{perContentNum}) cnt
	from daily_report d , employee e
	where d.employee_id = e.employee_id
		and d.department_id = (select department_id from employee where employee_id = #{user_id})
	<if test="employee_id != null">
	  	and d.employee_id = #{employee_id}
	</if>
	<if test="reg_date != null">
	   	and to_char(d.reg_date, 'yyyy-mm-dd') = #{reg_date}
	</if>
	<if test="approval_flag != null">
	   	and d.approval_flag = #{approval_flag}
	</if> 		

</select>







<select id="selectTeamMemberList" parameterType="java.lang.String" resultMap="DailyReportTeamListElement"> 
	select b.employee_id, b.employee_name, b.department_id, nvl(a.unApproval, 0) unApproval
	from (select employee_id, count(*) unApproval from DAILY_REPORT
	      where department_id = (select department_id from department where manager_id = #{value})
	            and approval_flag = 0
	      group by employee_id) a, employee b
	where 	b.employee_id != #{value}
			and a.employee_id(+) = b.employee_id
  order by b.employee_name asc
</select>





<select id="getTotalUnapprovalNum_Manager" parameterType="String" resultType="int">
	select count(*) from DAILY_REPORT
  	where department_id = (select department_id from department where manager_id = #{value}) 
    	    and APPROVAL_FLAG = 0
</select>




<select id="getTotalUnapprovalNum_Member" parameterType="String" resultType="int">
	select count(*) from DAILY_REPORT
  	where employee_id = #{value}
    	    and APPROVAL_FLAG = 0
</select>





	<select id="selectEmployee" parameterType="String" resultType="DailyReportEmployee">
	<![CDATA[select d.DEPARTMENT_NAME,e.employee_name,m.SALES_GOAL,e.employee_id from EMPLOYEE e, MONTHLY_GOAL m, department d 
       where e.employee_id=m.EMPLOYEE_ID and e.DEPARTMENT_ID=e.DEPARTMENT_ID and e.employee_id=#{employee_id} and m.YEAR=(select TO_CHAR(SYSDATE,'YYYY') from dual) and 
       m.MONTH=(select TO_CHAR(SYSDATE,'MM') from dual)]]>
	</select>
	
	<insert id="insertDailyReport" parameterType="DailyReport">
	<![CDATA[
	 insert into daily_report values(daily_report_seq.nextval,#{department_id},#{employee_id},#{title},#{reg_date},#{sales},#{before_gauge},#{after_gauge},#{content},'',0)
	]]>
	</insert>
	
	<select id="selectDailyReport" parameterType="String" resultType="DailyReportDetail">
	<![CDATA[
	select dr.daily_report_id,e.EMPLOYEE_ID,e.EMPLOYEE_NAME,e.FILE_POSITION, dr.TITLE,TO_CHAR(dr.REG_DATE,'YYYY-MM-DD') reg_date,dr.SALES as drsales,dr.BEFORE_GAUGE,
dr.AFTER_GAUGE,dr.CONTENT,wp.SALES as wpsales,dr.MANAGER_COMMENT, dr.APPROVAL_FLAG,e1.EMPLOYEE_NAME manager_name,e1.FILE_POSITION manager_file_position
from employee e, employee e1, daily_report dr, WEEKLY_REPORT wr, WEEKLY_PLAN wp, department d
where e.employee_id=dr.employee_id and  e.EMPLOYEE_ID=wr.EMPLOYEE_ID and 
wr.WEEKLY_REPORT_ID=wp.WEEKLY_REPORT_ID and wp.REG_DATE=dr.REG_DATE and 
e.EMPLOYEE_ID=dr.EMPLOYEE_ID and d.department_id=dr.department_id and e1.EMPLOYEE_ID=d.MANAGER_ID
and dr.daily_report_id=#{id}
	]]>
	</select>
	
	<select id="selectDailySalesGoal" parameterType="hashmap" resultType="Integer">
	<![CDATA[
		select p.SALES
		from EMPLOYEE e, WEEKLY_REPORT r, WEEKLY_PLAN p
		where e.EMPLOYEE_ID=r.EMPLOYEE_ID and r.WEEKLY_REPORT_ID=p.WEEKLY_REPORT_ID and p.REG_DATE=#{reg_date} and e.EMPLOYEE_ID=#{employee_id}
	]]>
	</select>
	
	<select id="selectCounselRecordList" parameterType="String" resultType="CounsellingRecord">
	<![CDATA[
	select cr.COUNSEL_ID,cr.title
	from daily_report dr,counsel_record cr
	where dr.daily_report_id=cr.daily_report_id and cr.daily_report_id=#{id} order by counsel_id
	]]>
	</select>
	
	<update id="updateApproval" parameterType="String">
		<![CDATA[
		update daily_report set approval_flag=1 where daily_report_id=#{daily_report_id}
		]]>
	</update>
	
</mapper>