<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.bne.mapper.DailyReport">




<resultMap type="DailyReportListElement" id="DailyReportListElement">
	<result column="employee_id" property="employee_id"/>
	<result column="employee_name" property="employee_name"/>
	<result column="title" property="title"/>
	<result column="reg_date" property="reg_date"/>
	<result column="approval_flag" property="approval_flag"/>
	<result column="idx" property="idx"/>
</resultMap>



<resultMap type="DailyReportTeamListElement" id="DailyReportTeamListElement">
	<result column="employee_id" property="employee_id"/>
	<result column="employee_name" property="employee_name"/>
	<result column="department_id" property="department_id"/>
	<result column="unApproval" property="unApproval"/>
</resultMap>



<!-- 전체 리스트 페이징(팀장 뷰에서 쓰일 것) -->
<select id="selectDailyReportList_All" parameterType="hashmap" resultMap="DailyReportListElement"> 

	select idx, employee_id, employee_name, title, reg_date, approval_flag
	from (select ROW_NUMBER() OVER (order by reg_date desc) idx, d.employee_id, e.employee_name, d.title, to_char(reg_date, 'yyyy-mm-dd') reg_date, approval_flag
	      from daily_report d , employee e
	      where d.employee_id = e.employee_id
	      		<choose>
	      			<when test="employee_id == null">
	      			and d.department_id = #{department_id}
	      			</when>
	      			<otherwise>
				      and d.employee_id = #{employee_id}
				    </otherwise>
	      		</choose>
	      		   
	      		) a  		
	where idx between (#{startIdx} - 1) * (#{perContentNum} + 1) and #{startIdx} + #{perContentNum} - 1
	order by idx asc 

</select>





<select id="getPagingNum_All" parameterType="hashmap" resultType="int"> 
	
	select ceil(count(*)/#{perContentNum}) cnt from
	(select *
	 from daily_report d , employee e
	 where d.employee_id = e.employee_id	 		
	 		<choose>
	      			<when test="employee_id == null">
	      			and d.department_id = #{department_id}
	      			</when>
	      			<otherwise>
				      and d.employee_id = #{employee_id}
				    </otherwise>
	      	</choose>
	 		
	 		) 
</select>





<select id="selectTeamMemberList" parameterType="java.lang.String" resultMap="DailyReportTeamListElement"> 
	select b.employee_id, b.employee_name, b.department_id, nvl(a.unApproval, 0) unApproval
	from (select employee_id, count(*) unApproval from DAILY_REPORT
	      where department_id = (select department_id from department where manager_id = #{value})
	            and approval_flag = 0
	      group by employee_id) a, employee b
	where a.employee_id(+) = b.employee_id
  order by b.employee_name asc
</select>





<select id="getTotalUnapprovalNum" parameterType="java.lang.String" resultType="int">
	select count(*) from DAILY_REPORT
  	where department_id = (select department_id from department where manager_id = #{value}) 
    	    and APPROVAL_FLAG = 0
</select>




<!-- 







<select id="getPagingNum_Employee" parameterType="" resultType="int"> 
	
	<![CDATA[
	select ceil(count(*)/15) cnt from
	(select d.employee_id, e.employee_name, d.title, reg_date, approval_flag
      from daily_report d , employee e
      where d.employee_id = e.employee_id
            and e.employee_id = #{employee_id})
	]]>

</select>



특정 날짜의 목록 페이징
<select id="selectList_RegDate" parameterType="" resultMap=""> 

	<![CDATA[
	select employee_id, employee_name, title, reg_date, approval_flag
	from (select ROW_NUMBER() OVER (order by reg_date desc) idx, d.employee_id, e.employee_name, d.title, reg_date, approval_flag
	      from daily_report d , employee e
	      where d.employee_id = e.employee_id
	            and to_char(d.reg_date, 'YYYY-MM-DD') = #{reg_date}) a
	where idx between #{startIdx} and #{startIdx} * 15
	order by idx asc 
	]]>

</select>


<select id="getPagingNum_RegDate" parameterType="" resultType="int"> 
	select ceil(count(*)/15) cnt from
	(select d.employee_id, e.employee_name, d.title, reg_date, approval_flag
      from daily_report d , employee e
      where d.employee_id = e.employee_id
            and to_char(d.reg_date, 'YYYY-MM-DD') = #{reg_date})
</select>





승인 되었는지 여부의 페이징
<select id="selectList_Approval" parameterType="" resultMap=""> 

	<![CDATA[
	
	select employee_id, employee_name, title, reg_date, approval_flag
	from (select ROW_NUMBER() OVER (order by reg_date desc) idx, d.employee_id, e.employee_name, d.title, reg_date, approval_flag
	      from daily_report d , employee e
	      where d.employee_id = e.employee_id
	            and approval_flag = #{approvalFlag}) a
	where idx between #{startIdx} and #{startIdx} * 15
	order by idx asc
	
	]]>

</select>



<select id="getPagingNum_Approval" parameterType="" resultType="int"> 
	select ceil(count(*)/15) cnt from
	(select d.employee_id, e.employee_name, d.title, reg_date, approval_flag
      from daily_report d , employee e
      where d.employee_id = e.employee_id
            and approval_flag = #{approval_flag})
</select>




 -->



</mapper>